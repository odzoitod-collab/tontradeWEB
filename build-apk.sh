#!/bin/bash

# ðŸš€ Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ APK Ð¸Ð· Ð²ÐµÐ±-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ TonTrader
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Capacitor Ð´Ð»Ñ ÐºÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð°Ñ†Ð¸Ð¸ React Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð² Android APK

echo "ðŸ“± Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ APK Ð´Ð»Ñ TonTrader..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Node.js
if ! command -v node &> /dev/null; then
    echo "âŒ Node.js Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Node.js 18+ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°."
    exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Java
if ! command -v java &> /dev/null; then
    echo "âŒ Java Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Java 11+ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°."
    exit 1
fi

echo "âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ð°"

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
if [ ! -d "node_modules" ]; then
    echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
    npm install
fi

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Capacitor ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
if [ ! -f "capacitor.config.ts" ]; then
    echo "âš¡ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Capacitor..."
    npm install @capacitor/core @capacitor/cli @capacitor/android
    
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Capacitor
    cat > capacitor.config.ts << EOF
import { CapacitorConfig } from '@capacitor/cli';

const config: CapacitorConfig = {
  appId: 'com.tontrader.app',
  appName: 'TonTrader',
  webDir: 'dist',
  server: {
    androidScheme: 'https'
  },
  plugins: {
    SplashScreen: {
      launchShowDuration: 2000,
      backgroundColor: "#000000",
      showSpinner: false
    }
  }
};

export default config;
EOF

    # Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Capacitor
    npx cap init TonTrader com.tontrader.app --web-dir=dist
    
    # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Android Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñƒ
    npx cap add android
fi

# Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð²ÐµÐ±-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
echo "ðŸ”¨ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð²ÐµÐ±-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
npm run build

if [ $? -ne 0 ]; then
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð²ÐµÐ±-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ"
    exit 1
fi

# Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ñ Android
echo "ðŸ”„ Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ Android..."
npx cap sync android

# Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ APK
echo "ðŸ“± Ð¡Ð±Ð¾Ñ€ÐºÐ° APK Ñ„Ð°Ð¹Ð»Ð°..."
cd android

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ gradlew
if [ ! -f "gradlew" ]; then
    echo "âŒ Gradle wrapper Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð² Android Studio Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°."
    exit 1
fi

# Ð”ÐµÐ»Ð°ÐµÐ¼ gradlew Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¼
chmod +x gradlew

# Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ debug APK (Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ)
./gradlew assembleDebug

if [ $? -eq 0 ]; then
    echo "âœ… APK ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½!"
    echo "ðŸ“ Ð Ð°ÑÐ¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ: android/app/build/outputs/apk/debug/app-debug.apk"
    
    # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ APK Ð² ÐºÐ¾Ñ€ÐµÐ½ÑŒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð´Ð»Ñ ÑƒÐ´Ð¾Ð±ÑÑ‚Ð²Ð°
    cp app/build/outputs/apk/debug/app-debug.apk ../tontrader-debug.apk
    echo "ðŸ“‹ Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½ ÐºÐ°Ðº: tontrader-debug.apk"
    
    # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð°
    size=$(du -h ../tontrader-debug.apk | cut -f1)
    echo "ðŸ“ Ð Ð°Ð·Ð¼ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð°: $size"
    
    echo ""
    echo "ðŸš€ Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ:"
    echo "1. Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ APK Ð½Ð° GitHub Releases"
    echo "2. Ð Ð°Ð·Ð¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ Ð½Ð° ÑÐ²Ð¾ÐµÐ¼ ÑÐµÑ€Ð²ÐµÑ€Ðµ"
    echo "3. ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ"
    echo ""
    echo "ðŸ“ Ð”Ð»Ñ production ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ:"
    echo "   ./gradlew assembleRelease"
    
else
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸ APK"
    exit 1
fi

cd ..

echo "ðŸŽ‰ ÐŸÑ€Ð¾Ñ†ÐµÑÑ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"