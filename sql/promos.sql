-- ==========================================
-- üéÅ 6. PROMOS (–£–ú–ù–´–ô –°–ö–†–ò–ü–¢: –°–û–ó–î–ê–ù–ò–ï + –û–ë–ù–û–í–õ–ï–ù–ò–ï)
-- ==========================================

-- 1. –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –∫–æ–¥–æ–≤ (–ï—Å–ª–∏ –µ—ë –Ω–µ—Ç)
CREATE TABLE IF NOT EXISTS public.promo_codes (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    code TEXT UNIQUE NOT NULL,            
    reward_amount FLOAT NOT NULL,         
    max_activations INT DEFAULT 100,      
    current_activations INT DEFAULT 0,    
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
);

-- 2. –ú–ò–ì–†–ê–¶–ò–Ø: –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏, –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –±—ã–ª–∞ —Å—Ç–∞—Ä–æ–π
-- (–≠—Ç–∏ –∫–æ–º–∞–Ω–¥—ã —Å—Ä–∞–±–æ—Ç–∞—é—Ç, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–æ–ª–æ–Ω–æ–∫ –µ—â–µ –Ω–µ—Ç)

-- –î–æ–±–∞–≤–ª—è–µ–º creator_id (–∫—Ç–æ —Å–æ–∑–¥–∞–ª –ø—Ä–æ–º–æ–∫–æ–¥)
DO $$ 
BEGIN 
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='promo_codes' AND column_name='creator_id') THEN
        ALTER TABLE public.promo_codes 
        ADD COLUMN creator_id BIGINT REFERENCES public.users(user_id) ON DELETE SET NULL;
    END IF;
END $$;

-- –î–æ–±–∞–≤–ª—è–µ–º description (–æ–ø–∏—Å–∞–Ω–∏–µ)
DO $$ 
BEGIN 
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='promo_codes' AND column_name='description') THEN
        ALTER TABLE public.promo_codes ADD COLUMN description TEXT;
        -- –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—É—Å—Ç—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
        UPDATE public.promo_codes SET description = '–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥' WHERE description IS NULL;
    END IF;
END $$;

-- 3. –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –∞–∫—Ç–∏–≤–∞—Ü–∏–π (–ö—Ç–æ –≤–≤–µ–ª –∫–æ–¥)
CREATE TABLE IF NOT EXISTS public.user_promos (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES public.users(user_id) ON DELETE CASCADE,
    promo_id BIGINT NOT NULL REFERENCES public.promo_codes(id) ON DELETE CASCADE,
    activated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()),
    UNIQUE(user_id, promo_id)             
);

-- ==========================================
-- ‚öôÔ∏è –õ–û–ì–ò–ö–ê (–¢–†–ò–ì–ì–ï–†–´ –ò –§–£–ù–ö–¶–ò–ò)
-- ==========================================

-- 4. –§—É–Ω–∫—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–∞ (–æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–ª-–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π)
CREATE OR REPLACE FUNCTION increment_promo_activations()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE public.promo_codes 
    SET current_activations = current_activations + 1
    WHERE id = NEW.promo_id;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- 5. –¢—Ä–∏–≥–≥–µ—Ä (–°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–ª—Å—è)
DROP TRIGGER IF EXISTS tr_increment_promo ON public.user_promos;

CREATE TRIGGER tr_increment_promo
AFTER INSERT ON public.user_promos
FOR EACH ROW EXECUTE FUNCTION increment_promo_activations();

-- ==========================================
-- üõ° –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ (RLS)
-- ==========================================

ALTER TABLE public.promo_codes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_promos ENABLE ROW LEVEL SECURITY;

-- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫ (–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç, –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å)
DO $$ 
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'promo_codes' AND policyname = 'Enable all for promos') THEN
        CREATE POLICY "Enable all for promos" ON public.promo_codes FOR ALL USING (true) WITH CHECK (true);
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'user_promos' AND policyname = 'Enable all for user_promos') THEN
        CREATE POLICY "Enable all for user_promos" ON public.user_promos FOR ALL USING (true) WITH CHECK (true);
    END IF;
END $$;

-- ==========================================
-- üß™ –¢–ï–°–¢–û–í–´–ï –î–ê–ù–ù–´–ï
-- ==========================================

-- –í—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–æ–º–æ–∫–æ–¥, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–∞–∫–æ–≥–æ –∫–æ–¥–∞ –µ—â–µ –Ω–µ—Ç (ON CONFLICT DO NOTHING)
INSERT INTO public.promo_codes (code, reward_amount, max_activations, description) 
VALUES ('BONUS2025', 1000, 10000, '–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –±–æ–Ω—É—Å')
ON CONFLICT (code) DO NOTHING;

SELECT '–¢–∞–±–ª–∏—Ü—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –≥–æ—Ç–æ–≤—ã –∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã! üéÅ' as status;